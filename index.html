<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DejandoHuella Trader</title>
  <meta name="description" content="Se√±ales en vivo y registro de operaciones." />
  <link rel="icon" href="img/logo.png" />
  <style>
    :root{
      --bg:#0e1320;--card:#141a2a;--muted:#9aa4b2;--text:#e8eefc;
      --ok:#2ed573;--warn:#ffd166;--fail:#ff6b6b;--accent:#5ce1a9;
      --line:#1f2740;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:980px;margin:28px auto;padding:0 14px}
    .header{display:flex;align-items:center;gap:14px}
    .brand{font-weight:700;font-size:20px}
    .btn{background:#1d8f5a;border:0;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    .card + .card{margin-top:18px}
    h2{margin:0 0 10px 0;font-size:22px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:right;white-space:nowrap}
    th:first-child,td:first-child{text-align:left}
    tr:last-child td{border-bottom:0}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .buy{background:rgba(46,213,115,.12);color:var(--ok);border:1px solid rgba(46,213,115,.35)}
    .sell{background:rgba(255,107,107,.12);color:var(--fail);border:1px solid rgba(255,107,107,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .live-shot{width:100%;display:block;border-radius:8px;border:1px solid var(--line);background:#0b0f1a}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;margin:4px 0}
    .key{color:var(--muted)}
    .actions{display:flex;gap:10px;margin-top:8px}
    .social{display:flex;gap:10px}
    .sbtn{border:1px solid var(--line);background:#1b2237;color:#cfe7ff;padding:10px 14px;border-radius:10px}
    details.ac{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:0}
    details.ac summary{cursor:pointer;list-style:none;padding:14px 16px;font-weight:700}
    details.ac summary::-webkit-details-marker{display:none}
    details.ac summary::before{content:"‚ñ∏ ";color:var(--muted)}
    details.ac[open] summary::before{content:"‚ñæ "}
    .acc-body{padding:4px 16px 16px 16px;border-top:1px solid var(--line)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="header">
      <img src="img/logo.png" alt="logo" width="42" height="42" />
      <div class="brand">DejandoHuella Trader</div>
      <div style="flex:1"></div>
      <button class="btn" onclick="window.open('https://wa.me/','_blank')">Solicitar informaci√≥n</button>
    </div>

    <div class="muted" id="lastUpdate" style="margin:6px 0 14px 0;">√öltima actualizaci√≥n: ‚Äî</div>

    <!-- Historial -->
    <div class="card">
      <h2>Historial reciente</h2>
      <div class="muted" id="noHistory" style="display:none">Sin operaciones a√∫n‚Ä¶</div>
      <div class="table-wrap">
        <table id="historyTbl" aria-label="Historial reciente">
          <thead>
            <tr>
              <th>Hora</th><th>Par</th><th>Lado</th><th>Precio</th>
              <th>Lote</th><th>SL</th><th>TP</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- En vivo -->
    <div class="card">
      <h2>Operaciones en vivo</h2>
      <div class="grid">
        <div>
          <div class="row"><div class="key">Par:</div>   <div id="liveSymbol">‚Äî</div></div>
          <div class="row"><div class="key">Lado:</div>  <div id="liveSide">‚Äî</div></div>
          <div class="row"><div class="key">Precio:</div><div id="livePrice">‚Äî</div></div>
          <div class="row"><div class="key">Lote:</div>  <div id="liveLot">‚Äî</div></div>
          <div class="row"><div class="key">SL / TP:</div>
            <div><span id="liveSL">‚Äî</span> / <span id="liveTP">‚Äî</span></div></div>
          <div class="row"><div class="key">Hora:</div>  <div id="liveTs">‚Äî</div></div>
        </div>
        <div>
          <img id="liveShot" class="live-shot" alt="Captura MT4 en vivo" src="live/shots/latest.jpg" />
        </div>
      </div>
    </div>

    <!-- Redes -->
    <div class="card">
      <h2>Redes oficiales</h2>
      <div class="muted">S√≠guenos para novedades y soporte:</div>
      <div class="social" style="margin-top:8px">
        <a class="sbtn" href="https://facebook.com" target="_blank" rel="noopener">Facebook</a>
        <a class="sbtn" href="https://wa.me/" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </div>

    <!-- üìÅ Medios de Pago + Planes (bloque plegable) -->
    <details class="ac" id="pagos-planes">
      <summary>üìÅ Medios de Pagos + Planes Premium ‚Äì DejandoHuella Trader</summary>
      <div class="acc-body">
        <h3 style="margin:6px 0 8px 0">Medios de pago</h3>
        <ul>
          <li><span class="mono">BTC</span> on-chain</li>
          <li><span class="mono">USDT (TRC20)</span></li>
          <li>Transferencia bancaria (consultar pa√≠ses disponibles)</li>
        </ul>

        <h3 style="margin:14px 0 8px 0">Planes Premium</h3>
        <ul>
          <li><b>Plan B√°sico</b>: historial y se√±al en vivo.</li>
          <li><b>Plan Pro</b>: incluye alertas priorizadas.</li>
          <li><b>Plan VIP</b>: soporte 1:1 y configuraci√≥n.</li>
        </ul>

        <div class="actions">
          <button class="btn" onclick="window.open('https://wa.me/','_blank')">Solicitar precios</button>
        </div>
      </div>
    </details>

    <div class="muted" style="text-align:center;margin:18px 0 40px 0">¬© 2025 DejandoHuella Trader</div>
  </div>

  <script>
    // util
    const $ = (s, p=document)=>p.querySelector(s);
    const fmt = n => Number(n).toLocaleString('es-PE',{maximumFractionDigits:2});
    const cacheBust = () => Math.floor(Date.now()/1000);

    // pintar √∫ltimo update en base al "ts" del live
    function setLastUpdate(ts){
      const el = $('#lastUpdate');
      if(!ts){ el.textContent='√öltima actualizaci√≥n: ‚Äî'; return; }
      el.textContent = '√öltima actualizaci√≥n: ' + ts.replaceAll('_',' ');
    }

    // cargar operaciones en vivo
    async function loadLive(){
      try{
        const r = await fetch('live/last.json?v=' + cacheBust(), {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();

        $('#liveSymbol').textContent = j.symbol ?? '‚Äî';
        const sideEl = $('#liveSide');
        const side = (j.side||'').toUpperCase();
        sideEl.innerHTML = side ? `<span class="pill ${side==='BUY'?'buy':'sell'}">${side}</span>` : '‚Äî';

        $('#livePrice').textContent = j.price ? fmt(j.price) : '‚Äî';
        $('#liveLot').textContent   = j.lot ?? '‚Äî';
        $('#liveSL').textContent    = j.sl ? fmt(j.sl) : '‚Äî';
        $('#liveTP').textContent    = j.tp ? fmt(j.tp) : '‚Äî';
        $('#liveTs').textContent    = j.ts  ?? '‚Äî';

        setLastUpdate(j.ts);

        const shot = $('#liveShot');
        // cache buster visual
        shot.src = 'live/shots/latest.jpg?v=' + cacheBust();
      }catch(e){
        console.error('live error', e);
      }
    }

    // cargar historial (toma las √∫ltimas 3 l√≠neas de trades.jsonl)
    async function loadHistory(){
      try{
        const r = await fetch('live/trades.jsonl?v=' + cacheBust(), {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const txt = await r.text();
        const lines = txt.trim().split(/\r?\n/).filter(Boolean);
        const last3 = lines.slice(-3).reverse(); // m√°s reciente primero

        const tbody = $('#historyTbl tbody');
        tbody.innerHTML = '';

        if(last3.length===0){
          $('#noHistory').style.display='block';
          $('#historyTbl').style.display='none';
          return;
        }else{
          $('#noHistory').style.display='none';
          $('#historyTbl').style.display='table';
        }

        last3.forEach(l=>{
          try{
            const j = JSON.parse(l);
            const tr = document.createElement('tr');
            const pill = `<span class="pill ${String(j.side).toUpperCase()==='BUY'?'buy':'sell'}">${(j.side||'').toUpperCase()}</span>`;
            tr.innerHTML = `
              <td>${j.ts??'‚Äî'}</td>
              <td>${j.symbol??'‚Äî'}</td>
              <td style="text-align:center">${pill}</td>
              <td>${j.price?fmt(j.price):'‚Äî'}</td>
              <td>${j.lot??'‚Äî'}</td>
              <td>${j.sl?fmt(j.sl):'‚Äî'}</td>
              <td>${j.tp?fmt(j.tp):'‚Äî'}</td>`;
            tbody.appendChild(tr);
          }catch(_){}
        });
      }catch(e){
        console.error('history error', e);
        $('#noHistory').style.display='block';
        $('#historyTbl').style.display='none';
      }
    }

    // refrezco peri√≥dico
    function tick(){
      loadLive(); loadHistory();
    }
    tick();
    setInterval(tick, 15000); // 15s
  </script>
</body>
</html>
