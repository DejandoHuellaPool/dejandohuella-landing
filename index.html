<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>DejandoHuella Trader ‚Äî Panel</title>

  <style>
    :root{
      --bg:#0c1117;
      --card:#121a24;
      --muted:#9fb3c8;
      --text:#e5edf5;
      --accent:#00c16a;
      --accent-2:#2ea3f2;
      --danger:#ff4d4d;
      --border:#1e2a36;
      --chip:#0f1720;
      --shadow:0 6px 22px rgba(0,0,0,.35);
      --radius:14px;
      --radius-sm:10px;
      --font: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:radial-gradient(80% 120% at 100% 0%,#0e1622 0%, var(--bg) 60%) no-repeat fixed;
      line-height:1.45;
    }
    a{color:var(--accent-2);text-decoration:none}
    .wrap{max-width:1060px;margin:28px auto;padding:0 14px}

    /* Top Notice + Controls */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(12,17,23,.92), rgba(12,17,23,.70));
      backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{max-width:1060px;margin:0 auto;padding:8px 14px;display:flex;gap:8px;align-items:center}
    .badge{
      font-family:var(--mono);
      font-size:.68rem;
      background:#0a2a18;border:1px solid #164c2d;color:#9ff2c4;
      padding:6px 8px;border-radius:10px;box-shadow:var(--shadow);
    }
    .tiny-controls{margin-left:auto;display:flex;gap:8px}
    .btn-tiny{
      font-size:.68rem;line-height:1;
      padding:6px 8px;border-radius:8px;border:1px solid var(--border);
      background:var(--chip);color:var(--muted);cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;box-shadow:0 2px 0 rgba(0,0,0,.18);
    }
    .btn-tiny.success{background:#0f2b1e;border-color:#1f5e45;color:#b6ffe3}
    .btn-tiny.warn{background:#29120f;border-color:#6a251d;color:#ffb3a7}
    .btn-tiny.blue{background:#0f2334;border-color:#1b4a6b;color:#a7d9ff}
    .btn-tiny:hover{filter:brightness(1.12)}

    /* Card */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card-body{padding:14px 18px}
    .title{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:36px;height:36px;border-radius:10px;background:#1b2836;border:1px solid var(--border);display:grid;place-content:center;font-weight:800}

    .pill{font-size:.72rem;padding:6px 10px;border-radius:999px;background:#0d1b27;border:1px solid var(--border);color:#a8c3d7}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:840px){
      .grid{grid-template-columns:1fr}
    }

    /* History Table */
    table{width:100%;border-collapse:collapse;font-size:.88rem}
    th,td{padding:10px 8px;border-bottom:1px dashed #1d2a36}
    th{font-weight:600;color:#9fbad0;text-transform:uppercase;font-size:.72rem;letter-spacing:.02em}
    .buy{color:#46e79a;font-weight:700}
    .sell{color:#ff7777;font-weight:700}
    .mono{font-family:var(--mono);font-size:.86rem}

    /* Live block */
    .kv{display:grid;grid-template-columns:repeat(2,auto);gap:10px 22px;margin:8px 0 12px}
    .kv b{color:#9fbad0;font-weight:600}
    .shot{
      width:100%;aspect-ratio:16/9;border-radius:12px;
      border:1px solid var(--border);background:#0b141e;
      object-fit:contain;display:block;box-shadow:var(--shadow)
    }
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .row .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1723;color:#b8d2ea;cursor:pointer}
    .row .btn.green{background:#0f2b1f;color:#bfffe8;border-color:#1c6046}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .social{display:flex;gap:10px}
    .social a{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1723;color:#cde3ff}
    .social a.whatsapp{background:#0d2a1d;border-color:#1d5b41;color:#b3ffe1}
    .muted{color:#99adc2}
    .small{font-size:.82rem}

    /* Accordion */
    .accordion{border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
    .acc-item + .acc-item{border-top:1px solid var(--border)}
    .acc-btn{width:100%;text-align:left;background:#0e1622;color:var(--text);padding:14px 16px;border:0;display:flex;align-items:center;gap:10px;cursor:pointer}
    .acc-panel{display:none;padding:12px 16px;background:#0c131e}
    .qr-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;align-items:start}
    .qr{background:#0e1724;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}
    .qr img{max-width:220px;width:100%;height:auto;border-radius:8px;display:block;margin:6px auto}
    .label{font-size:.78rem;color:#9fbad0;margin-top:6px}

    /* PGP Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:200}
    .modal.open{display:grid}
    .modal-card{width:min(720px,94vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .modal-card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal-body{padding:14px}
    .pgp{width:100%;min-height:240px;background:#0a1420;color:#a7c7dd;border:1px solid #1b3248;border-radius:10px;padding:12px;font-family:var(--mono);font-size:.82rem;white-space:pre;overflow:auto}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border)}

    .timestamp{color:#7fa5c4;font-family:var(--mono);font-size:.78rem}
    footer{padding:30px 6px;color:#6d839a;text-align:center}
    .sep{height:18px}

    /* Mobile controls sizing */
    @media(max-width:560px){
      .btn-tiny{padding:5px 7px;font-size:.66rem}
      .badge{padding:5px 6px;font-size:.62rem}
      .title .logo{width:30px;height:30px}
      .kv{grid-template-columns:auto 1fr}
      .social a{padding:9px 10px}
      .row .btn{padding:8px 10px}
    }
  </style>
</head>
<body>
  <!-- Top notice -->
  <div class="topbar">
    <div class="topbar-inner">
      <span class="badge">‚ö†Ô∏è Verifica los enlaces. Usa la Verificaci√≥n oficial o la direcci√≥n .onion.</span>
      <div class="tiny-controls">
        <button id="btnRefresh" class="btn-tiny">‚Üª Actualizar</button>
        <button id="btnAuto" class="btn-tiny blue" aria-pressed="false">‚è± Auto 5s: OFF</button>
        <button id="btnPGP" class="btn-tiny success">üîê PGP</button>
        <button id="btnClose" class="btn-tiny warn">‚úï Cerrar</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <div class="card-head">
        <div class="title">
          <div class="logo">üêæ</div>
          <div>
            <div style="font-size:1.05rem;font-weight:800">DejandoHuella Trader</div>
            <div class="timestamp">√öltima actualizaci√≥n: <span id="lastUpdate">‚Äî</span></div>
          </div>
        </div>
        <button id="btnInfo" class="pill">Solicitar informaci√≥n</button>
      </div>
    </div>

    <div class="sep"></div>

    <!-- History + Live -->
    <div class="grid">
      <!-- History -->
      <section class="card" id="historyCard">
        <div class="card-head">
          <div class="title">üìú <span>Historial reciente</span></div>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="tblHistory" aria-label="Historial de operaciones">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Par</th>
                  <th>Lado</th>
                  <th>Precio</th>
                  <th>Lote</th>
                  <th>SL</th>
                  <th>TP</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7" class="muted small">Cargando historial‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Live -->
      <section class="card" id="liveCard">
        <div class="card-head">
          <div class="title">üü¢ <span>Operaciones en vivo</span></div>
        </div>
        <div class="card-body">
          <div class="kv">
            <b>Par:</b>    <div id="kvSymbol" class="mono">‚Äî</div>
            <b>Lado:</b>   <div id="kvSide" class="mono">‚Äî</div>
            <b>Precio:</b> <div id="kvPrice" class="mono">‚Äî</div>
            <b>Lote:</b>   <div id="kvLot" class="mono">‚Äî</div>
            <b>SL / TP:</b><div id="kvSLTP" class="mono">‚Äî</div>
            <b>Hora:</b>   <div id="kvTime" class="mono">‚Äî</div>
          </div>

          <img id="liveShot" alt="Captura MT4 en vivo" class="shot" src="live/shots/latest.jpg" loading="lazy">

          <div class="sep"></div>
          <div class="actions">
            <div class="social">
              <a href="https://facebook.com" target="_blank" rel="noopener">üìò Facebook</a>
              <a class="whatsapp" href="https://wa.me/" target="_blank" rel="noopener">üü¢ WhatsApp</a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="sep"></div>

    <!-- Payments -->
    <section class="accordion">
      <div class="acc-item">
        <button class="acc-btn" data-acc>üí≥ Medios de Pagos + Planes Premium ‚Äì DejandoHuella Trader</button>
        <div class="acc-panel">
          <div class="qr-wrap">
            <div class="qr">
              <div class="label">Banco Pichincha</div>
              <img src="img/qr_pichincha.png" alt="QR Banco Pichincha">
              <div class="small muted mono">Titular / Ref: **Actualiza con tus datos**</div>
            </div>
            <div class="qr">
              <div class="label">Cripto (BEP20)</div>
              <img src="img/qr_bep20.png" alt="QR BEP20">
              <div class="small muted mono">Direcci√≥n: <span id="addrBep20">‚Äî</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>¬© <span id="yyyy"></span> DejandoHuella Trader</footer>
  </div>

  <!-- PGP Modal -->
  <div id="pgpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pgpTitle">
    <div class="modal-card">
      <h3 id="pgpTitle">üîê PGP p√∫blico (verifica huella/fingerprint)</h3>
      <div class="modal-body">
        <pre id="pgpBlock" class="pgp">-----BEGIN PGP PUBLIC KEY BLOCK-----
mQINBGWlZGgBEADG6q8v5g2jUo2qJH+9V3S1mSsc9m2Xf9dS4e2Zkqk7i5bBqVg1
IX9w6z2pG3b6sD6t0lQmQ3QqzvboC1Av8i9r4Gg1HfWPa3x6X3zZ4sJr+V8mYI7e
QfG7Xk3JcW5QvD0qS9p3mw6A2oUqf4J6X4n3KQJ4ax+8hwmN0ZkT7ZJ5qF9o4Vbq
‚Ä¶ (reemplaza con tu clave real)
-----END PGP PUBLIC KEY BLOCK-----</pre>
      </div>
      <div class="modal-actions">
        <button class="btn-tiny blue" id="btnCopyPGP">Copiar</button>
        <button class="btn-tiny warn" id="btnClosePGP">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
    const fmt = (n)=> (n==null||n==='') ? '‚Äî' : Number(n).toLocaleString('en-US',{maximumFractionDigits:5});
    const qv = ()=> `?v=${Date.now()}`;

    // UI basic
    const lastUpdateEl = $("#lastUpdate");
    const shotEl = $("#liveShot");
    const autoBtn = $("#btnAuto");
    const pgpModal = $("#pgpModal");

    // Persist auto refresh
    let auto = localStorage.getItem("auto5s") === "1";
    const setAutoLabel = ()=> {
      autoBtn.setAttribute('aria-pressed', auto ? 'true':'false');
      autoBtn.textContent = `‚è± Auto 5s: ${auto?"ON":"OFF"}`;
    };
    setAutoLabel();

    // Actions
    $("#btnRefresh").addEventListener("click", refreshAll);
    autoBtn.addEventListener("click", ()=>{
      auto = !auto; localStorage.setItem("auto5s", auto?"1":"0");
      setAutoLabel();
    });
    $("#btnClose").addEventListener("click", ()=> window.scrollTo({top:0,behavior:'smooth'}));
    $("#btnPGP").addEventListener("click", ()=> pgpModal.classList.add("open"));
    $("#btnClosePGP").addEventListener("click", ()=> pgpModal.classList.remove("open"));
    $("#btnCopyPGP").addEventListener("click", ()=>{
      const t = $("#pgpBlock").innerText; navigator.clipboard.writeText(t);
    });

    // Accordion
    $$("[data-acc]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const panel = btn.parentElement.querySelector(".acc-panel");
        const open = panel.style.display === "block";
        panel.style.display = open ? "none":"block";
      });
    });

    // Loaders
    async function loadJSON(urls){
      for(const url of urls){
        try{
          const res = await fetch(url + qv(), {cache:"no-store"});
          if(res.ok){ return await res.json(); }
        }catch(_){/* try next */}
      }
      return null;
    }

    function setLive(info){
      if(!info) return;
      const sideC = (info.side||"").toUpperCase()==="BUY" ? "buy" : ( (info.side||"").toUpperCase()==="SELL" ? "sell" : "" );
      $("#kvSymbol").textContent = info.symbol ?? "‚Äî";
      $("#kvSide").innerHTML = sideC ? `<span class="${sideC}">${(info.side||"").toUpperCase()}</span>` : (info.side||"‚Äî");
      $("#kvPrice").textContent = fmt(info.price);
      $("#kvLot").textContent = fmt(info.lot);
      $("#kvSLTP").textContent = `${fmt(info.sl)} / ${fmt(info.tp)}`;
      $("#kvTime").textContent = info.ts ?? "‚Äî";
      // refresh shot
      shotEl.src = "live/shots/latest.jpg" + qv();
    }

    function setHistory(list){
      const tb = $("#tblHistory tbody");
      tb.innerHTML = "";
      if(!list || !list.length){
        tb.innerHTML = `<tr><td colspan="7" class="muted small">Sin operaciones a√∫n‚Ä¶</td></tr>`;
        return;
      }
      // Mostramos √∫ltimos 5
      list.slice(-5).reverse().forEach(o=>{
        const sideC = (o.side||"").toUpperCase()==="BUY" ? "buy" : ( (o.side||"").toUpperCase()==="SELL" ? "sell" : "" );
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${o.ts ?? "‚Äî"}</td>
          <td class="mono">${o.symbol ?? "‚Äî"}</td>
          <td class="${sideC}">${(o.side||"").toUpperCase()}</td>
          <td class="mono">${fmt(o.price)}</td>
          <td class="mono">${fmt(o.lot)}</td>
          <td class="mono">${fmt(o.sl)}</td>
          <td class="mono">${fmt(o.tp)}</td>`;
        tb.appendChild(tr);
      });
    }

    async function refreshAll(){
      lastUpdateEl.textContent = new Date().toISOString().slice(0,19).replace("T"," ");
      // live
      const live = await loadJSON(["live/last.json","live/last.jsonl"]);
      if(live) setLive(live);
      // history (acepta json o jsonl)
      let trades = await loadJSON(["live/trades.json","live/trades.jsonl"]);
      if(Array.isArray(trades)){ setHistory(trades); }
      else if(trades && typeof trades === "string"){
        try{
          const lines = trades.trim().split(/\r?\n/).map(l=>JSON.parse(l));
          setHistory(lines);
        }catch(_){ setHistory([]); }
      }else setHistory([]);
    }

    refreshAll();
    setInterval(()=>{ if(auto) refreshAll(); }, 5000);

    // misc
    $("#yyyy").textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>
