<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DejandoHuella Trader</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="img/logo.png" />

  <style>
    :root{
      --bg:#0e141b;
      --panel:#151c24;
      --panel2:#101721;
      --muted:#8ea0b5;
      --txt:#e6eef8;
      --accent:#20d07a;
      --danger:#e15a6e;
      --brand:#1aa774;
      --border: #223043;
      --chip:#1a2532;
      --chipTxt:#cfe0f4;
      --badge:#0f1b28;
      --badgeTxt:#9bb2cb;
      --shadow: 0 6px 16px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    a{color:#9ad1ff}
    img{max-width:100%;display:block}

    .wrap{max-width:960px;margin:0 auto;padding:24px 14px 60px}

    /* Header */
    .brand{
      display:flex;align-items:center;gap:12px;margin:6px 0 12px
    }
    .brand-badge{
      width:42px;height:42px;border-radius:50%;
      background:url("img/logo.png") center/cover no-repeat,#222;
      box-shadow:0 0 0 3px #243244, inset 0 0 0 2px #000;
    }
    .brand-title{font-weight:700}
    .cta{
      margin-left:auto;background:linear-gradient(180deg,#25e37f,#17b162);
      border:none;color:#061014;font-weight:700;padding:8px 12px;border-radius:12px;cursor:pointer
    }

    .last-upd{font-size:.86rem;color:var(--muted);margin:4px 0 18px}

    /* Card base */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card+.card{margin-top:14px}
    .card-h{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .card-b{padding:12px 14px}
    .muted{color:var(--muted)}

    /* Historial */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px dashed #233041;text-align:left}
    th{color:#bcd2ea;font-size:.82rem;font-weight:700}
    tbody tr:last-child td{border-bottom:none}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:10px;font-weight:700;font-size:.75rem
    }
    .pill-buy{background:#092819;color:#4df29e;border:1px solid #1a7a4c}
    .pill-sell{background:#2a1217;color:#ff9aa8;border:1px solid #9a4554}

    /* Live */
    .kv{display:grid;grid-template-columns:88px 1fr;gap:8px 12px;margin-bottom:12px}
    .kv b{color:#bcd2ea}
    .shot{background:var(--panel2);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .shot img{width:100%;height:auto;display:block}

    /* Payments (accordion) */
    details.pay{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    details.pay summary{
      list-style:none;padding:14px;cursor:pointer;font-weight:700;
      display:flex;align-items:center;gap:10px
    }
    details.pay summary::marker{display:none}
    .pay-body{padding:0 14px 14px}
    .grid-qr{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .qr-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
    .qr-card h4{margin:4px 0 8px;font-size:.95rem}
    .qr-card img{border-radius:10px;border:1px solid #203048;background:#081018}
    .qr-note{font-size:.8rem;color:var(--muted)}
    @media (max-width:560px){.grid-qr{grid-template-columns:1fr}}

    /* Footer socials */
    .socials{display:flex;gap:10px}
    .btn{
      border:1px solid #2a3a4f;background:var(--chip);color:var(--chipTxt);
      padding:8px 12px;border-radius:12px;cursor:pointer
    }
    .btn.whatsapp{background:#1b4a2b;border-color:#1b4a2b;color:#9ff1c6}
    .btn.facebook{background:#193153;border-color:#203b60;color:#c6dbff}

    /* ——— Top right controls (Actualizar / Auto / Cerrar) ——— */
    .topbar{
      position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(14,20,27,.92), rgba(14,20,27,.72));
      backdrop-filter: blur(6px);
    }
    .top-controls{
      max-width:960px;margin:0 auto;padding:6px 10px;display:flex;gap:8px;align-items:center;justify-content:flex-start
    }
    .chip-btn{
      background:var(--badge);color:var(--badgeTxt);border:1px solid #284058;border-radius:999px;
      padding:6px 10px;font-size:.78rem;line-height:1;cursor:pointer;user-select:none;
      transition:transform .06s ease, background .2s ease, color .2s ease, border-color .2s ease
    }
    .chip-btn:hover{transform:translateY(-1px)}
    .chip-btn.active{background:#153c2a;border-color:#1f704c;color:#98eec8}
    .chip-btn.danger{background:#2b1317;border-color:#5f2b37;color:#ff98a9}
    .spacer{flex:1 1 auto}
    @media (max-width:480px){
      .chip-btn{padding:5px 9px;font-size:.72rem}   /* más pequeño en móvil */
    }

    /* PGP */
    .pgp-wrap{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:12px}
    textarea.pgp{
      width:100%;min-height:160px;resize:vertical;border-radius:10px;border:1px solid #223244;
      background:#09131c;color:#cde1f9;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }
    .pgp-actions{display:flex;gap:8px;margin-top:8px}

    /* Chips info */
    .note{color:var(--muted);font-size:.82rem}
    .hr{height:1px;background:#223244;margin:10px 0}
  </style>
</head>

<body>
  <!-- Sticky mini-controles arriba -->
  <div class="topbar">
    <div class="top-controls">
      <button id="btnRefresh" class="chip-btn">Actualizar</button>
      <button id="btnAuto" class="chip-btn">Auto 5s</button>
      <div class="spacer"></div>
      <button id="btnClose" class="chip-btn danger">Cerrar</button>
    </div>
  </div>

  <div class="wrap">
    <div class="brand">
      <span class="brand-badge" aria-hidden="true"></span>
      <div class="brand-title">DejandoHuella Trader</div>
      <button class="cta" onclick="window.open('https://wa.me/','_blank')">Solicitar información</button>
    </div>

    <div id="lastUpdate" class="last-upd">Última actualización: —</div>

    <!-- HISTORIAL -->
    <section class="card" id="hist">
      <div class="card-h">Historial reciente</div>
      <div class="card-b">
        <div class="note" id="histEmpty">Sin operaciones aún…</div>
        <div id="histTblWrap" style="display:none">
          <table>
            <thead>
              <tr>
                <th>Hora</th><th>Par</th><th>Lado</th><th>Precio</th><th>Lote</th><th>SL</th><th>TP</th>
              </tr>
            </thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- EN VIVO -->
    <section class="card" id="live">
      <div class="card-h">Operaciones en vivo</div>
      <div class="card-b">
        <div class="kv">
          <b>Par:</b>   <span id="lv_pair" class="muted">—</span>
          <b>Lado:</b>  <span id="lv_side" class="muted">—</span>
          <b>Precio:</b><span id="lv_price" class="muted">—</span>
          <b>Lote:</b>  <span id="lv_lot" class="muted">—</span>
          <b>SL / TP:</b><span id="lv_sltp" class="muted">—</span>
          <b>Hora:</b>  <span id="lv_time" class="muted">—</span>
        </div>

        <div class="shot">
          <img id="shot" src="live/shots/latest.jpg?v=0" alt="Captura MT4 en vivo" />
        </div>
      </div>
    </section>

    <!-- REDES -->
    <section class="card">
      <div class="card-h">Redes oficiales</div>
      <div class="card-b">
        <div class="socials">
          <a class="btn facebook" href="https://facebook.com" target="_blank" rel="noopener">Facebook</a>
          <a class="btn whatsapp" href="https://wa.me/" target="_blank" rel="noopener">WhatsApp</a>
        </div>
      </div>
    </section>

    <!-- PAGOS + PLANES -->
    <details class="pay card" id="pay">
      <summary>💳 &nbsp;Medios de Pagos + Planes Premium – DejandoHuella Trader</summary>
      <div class="pay-body">

        <h3 style="margin:10px 0 8px">Cripto / Cadenas</h3>
        <div class="grid-qr">
          <div class="qr-card">
            <h4>BEP20 (BNB Smart Chain)</h4>
            <img src="img/qr_bep20.png" alt="QR BEP20" />
            <div class="qr-note">Escanea o solicita la dirección</div>
          </div>
          <div class="qr-card">
            <h4>ERC20 (Ethereum)</h4>
            <img src="img/qr_erc20.png" alt="QR ERC20" />
            <div class="qr-note">Escanea o solicita la dirección</div>
          </div>
          <div class="qr-card">
            <h4>TRC20 (Tron)</h4>
            <img src="img/qr_trc20.png" alt="QR TRC20" />
            <div class="qr-note">Escanea o solicita la dirección</div>
          </div>
          <div class="qr-card">
            <h4>BTC (Bitcoin)</h4>
            <img src="img/qr_btc.png" alt="QR BTC" />
            <div class="qr-note">Escanea o solicita la dirección</div>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="margin:10px 0 8px">Bancos</h3>
        <div class="grid-qr">
          <div class="qr-card">
            <h4>Banco Pichincha</h4>
            <!-- Ajusta el nombre del archivo si tu QR tiene otro nombre -->
            <img src="img/qr_pichincha.png" alt="QR Banco Pichincha" />
            <div class="qr-note">Cuenta/CCI verificada – solicitar detalle exacto para depósito</div>
          </div>
          <div class="qr-card">
            <h4>Interbancario</h4>
            <img src="img/qr_arb1.png" alt="QR Interbancario" />
            <div class="qr-note">Opción de respaldo</div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Botón PGP y bloque -->
        <div class="pgp-wrap">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <strong>PGP para mensajes cifrados</strong>
            <div class="pgp-actions">
              <button id="btnTogglePGP" class="chip-btn">Mostrar PGP</button>
              <button id="btnCopyPGP"   class="chip-btn">Copiar</button>
            </div>
          </div>
          <div id="pgpBlock" style="display:none;margin-top:8px">
            <textarea class="pgp" id="pgpText" spellcheck="false" readonly>-----BEGIN PGP PUBLIC KEY BLOCK-----
xjMEZAlHnBYJKwYBBAHaRw8BAQdA1QG8EETChubc5ySa6PyQwLMk
gA6laQ3P1+F6w9i0cS0gRGVqYW5kb0h1ZWxsYSBUcmFkZXIgPGNvbnRhY3RvQGVqZW1wbG8uY29tPsKMBBAWCgA+BYJkCUecBAsJBwgJkM3K0kxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
=ecvG
-----END PGP PUBLIC KEY BLOCK-----</textarea>
            <div class="qr-note">Compara siempre la huella (“fingerprint”).</div>
          </div>
        </div>

      </div>
    </details>

  </div><!-- /wrap -->

  <script>
    /***********************
     * Utilidades
     ************************/
    const $ = sel => document.querySelector(sel);
    const nowStr = () => {
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
             ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    };

    function badge(side){
      if(!side) return '';
      const s = String(side).toUpperCase();
      return `<span class="pill ${s==='BUY'?'pill-buy':'pill-sell'}">${s}</span>`;
    }

    function safe(v, empty='—'){
      if(v===undefined || v===null || v==='') return empty;
      return v;
    }

    /***********************
     * Carga de datos
     ************************/
    const lastURL   = 'live/last.json';
    const tradesURL = 'live/trades.jsonl'; // JSON Lines (una operación por línea)

    async function fetchJSON(url){
      const res = await fetch(url + '?v=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    async function fetchJSONL(url){
      const res = await fetch(url + '?v=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      // cada línea un JSON
      return text.trim().split(/\r?\n/).filter(Boolean).map(l=>{ try{return JSON.parse(l)}catch(e){return null} }).filter(Boolean);
    }

    async function loadHistory(){
      try{
        const rows = await fetchJSONL(tradesURL);
        if(!rows.length){
          $('#histEmpty').style.display='';
          $('#histTblWrap').style.display='none';
          return;
        }
        $('#histEmpty').style.display='none';
        $('#histTblWrap').style.display='';
        // Tomar los últimos 3 (o menos)
        const last3 = rows.slice(-3).reverse();
        const tbody = $('#histBody');
        tbody.innerHTML = last3.map(r=>{
          const side = badge(r.side);
          return `<tr>
            <td>${safe(r.ts,'—')}</td>
            <td>${safe(r.symbol,'—')}</td>
            <td>${side}</td>
            <td>${safe(r.price,'—')}</td>
            <td>${safe(r.lot,'—')}</td>
            <td>${safe(r.sl,'—')}</td>
            <td>${safe(r.tp,'—')}</td>
          </tr>`;
        }).join('');
      }catch(e){
        console.warn('Hist fail', e);
      }
    }

    async function loadLive(){
      try{
        const j = await fetchJSON(lastURL);
        $('#lv_pair').textContent  = safe(j.symbol,'—');
        $('#lv_side').innerHTML    = badge(j.side);
        $('#lv_price').textContent = safe(j.price,'—');
        $('#lv_lot').textContent   = safe(j.lot,'—');
        $('#lv_sltp').textContent  = `${safe(j.sl,'—')} / ${safe(j.tp,'—')}`;
        $('#lv_time').textContent  = safe(j.ts,'—');
      }catch(e){
        console.warn('Live fail', e);
      }
    }

    function refreshShot(){
      const img = $('#shot');
      const base = 'live/shots/latest.jpg';
      img.src = base + '?v=' + Date.now();
    }

    async function refreshAll(){
      $('#lastUpdate').textContent = 'Última actualización: ' + nowStr();
      await Promise.all([
        loadHistory(),
        loadLive()
      ]);
      refreshShot();
    }

    /***********************
     * Top buttons
     ************************/
    let autoTimer = null;

    function setAuto(on){
      $('#btnAuto').classList.toggle('active', !!on);
      if(on){
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(refreshAll, 5000);
      }else{
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = null;
      }
    }

    $('#btnRefresh').addEventListener('click', refreshAll);
    $('#btnAuto').addEventListener('click', ()=> setAuto(!autoTimer));
    $('#btnClose').addEventListener('click', ()=> {
      // Minimiza los controles: oculta la barrita hasta el próximo scroll-up
      document.querySelector('.topbar').style.display='none';
      setTimeout(()=>{ /* vuelve si el usuario refresca manual */ }, 0);
    });

    // PGP
    const pgpWrap = $('#pgpBlock');
    $('#btnTogglePGP').addEventListener('click', ()=>{
      const s = pgpWrap.style.display;
      pgpWrap.style.display = (s===''||s==='none') ? 'block' : 'none';
    });
    $('#btnCopyPGP').addEventListener('click', ()=>{
      const ta = $('#pgpText');
      ta.select(); ta.setSelectionRange(0, 999999);
      document.execCommand('copy');
      const b = $('#btnCopyPGP');
      const old = b.textContent;
      b.textContent = '¡Copiado!';
      setTimeout(()=> b.textContent = old, 1200);
    });

    // primera carga
    refreshAll();
    // Si quieres que inicie con Auto 5s activo, descomenta:
    // setAuto(true);
  </script>
</body>
</html>
