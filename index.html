<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DejandoHuella Trader â€” Live</title>
  <meta name="color-scheme" content="dark" />
  <link rel="preload" as="image" href="live/shots/latest.jpg" />
  <style>
    :root{
      --bg:#0b1118;
      --card:#111a24;
      --muted:#8ea0b5;
      --line:#223244;
      --green:#1f9d61;
      --green-2:#163e2d;
      --accent:#4ea1ff;
      --bad:#f05d7a;
    }
    html,body{background:var(--bg);color:#dbe8ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:960px;margin:28px auto;padding:0 14px}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .brand img{width:36px;height:36px;border-radius:10px}
    .badge{display:inline-block;background:#13324d;border:1px solid var(--line);border-radius:10px;padding:6px 10px;color:#cde1f9;font-size:.85rem}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:8px;border-bottom:1px dashed var(--line);text-align:center}
    th{color:#a8c0da;font-weight:600}
    .ok{color:#98eec8}
    .muted{color:var(--muted);font-size:.85rem}
    /* live shot */
    .shot{display:block;width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#081018}
    /* topbar small controls */
    .topbar{position:sticky;top:0;z-index:9999;background:rgba(10,16,23,.82);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    .topbar__inner{max-width:960px;margin:0 auto;padding:6px 10px;display:flex;gap:8px;align-items:center}
    .chip{background:#0f1b28;border:1px solid #284058;color:#9bb2cb;border-radius:999px;padding:6px 10px;font-size:.78rem;line-height:1;cursor:pointer}
    .chip--ok{background:#153c2a;border-color:#1f704c;color:#98eec8}
    .chip--bad{background:#2b1317;border-color:#5f2b37;color:#ff98a9}
    @media (max-width:480px){.chip{padding:5px 9px;font-size:.72rem}}
    /* modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:10000}
    .modal__card{width:min(840px,92vw);max-height:85vh;overflow:auto;background:#101721;border:1px solid var(--line);
      border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:12px}
    .modal__hdr{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .txtarea{
      width:100%;min-height:220px;resize:vertical;border-radius:10px;border:1px solid var(--line);
      background:#09131c;color:#cde1f9;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }
    /* payments */
    .pay-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:560px){.pay-grid{grid-template-columns:1fr}}
    .pay-card{background:#0f1620;border:1px solid var(--line);border-radius:12px;padding:12px}
    .note{font-size:.82rem;color:var(--muted)}
    details.card summary{cursor:pointer;list-style:none}
    details.card summary::-webkit-details-marker{display:none}
    .btn{border:1px solid var(--line);background:#0f1b28;color:#cde1f9;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <!-- compact controls -->
  <div class="topbar">
    <div class="topbar__inner">
      <button id="btnRefresh" class="chip">Actualizar</button>
      <button id="btnAuto" class="chip">Auto 5s</button>
      <div style="flex:1"></div>
      <button id="btnPGP" class="chip chip--ok" title="PGP pÃºblico">PGP</button>
      <button id="btnCloseBar" class="chip chip--bad">Cerrar</button>
    </div>
  </div>

  <div class="wrap">
    <div class="brand">
      <img src="img/logo.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:700">DejandoHuella Trader</div>
        <div id="lastUpdate" class="muted">Ãšltima actualizaciÃ³n: â€”</div>
      </div>
      <div style="flex:1"></div>
      <a href="#contact" class="badge">Solicitar informaciÃ³n</a>
    </div>

    <div class="grid">
      <section class="card">
        <h3 style="margin:2px 0 10px">Historial reciente</h3>
        <table id="tblHistory">
          <thead>
            <tr><th>Hora</th><th>Par</th><th>Lado</th><th>Precio</th><th>Lote</th><th>SL</th><th>TP</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="muted">Sin operaciones aÃºnâ€¦</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h3 style="margin:2px 0 10px">Operaciones en vivo</h3>
        <div class="muted" id="liveFields">
          <div>Par: <b id="f_symbol">â€”</b></div>
          <div>Lado: <b id="f_side">â€”</b></div>
          <div>Precio: <b id="f_price">â€”</b></div>
          <div>Lote: <b id="f_lot">â€”</b></div>
          <div>SL / TP: <b id="f_sl">â€”</b> / <b id="f_tp">â€”</b></div>
          <div>Hora: <b id="f_time">â€”</b></div>
        </div>
        <div style="margin-top:10px">
          <img id="shot" class="shot" src="live/shots/latest.jpg" alt="Captura MT4 en vivo">
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h3 style="margin:2px 0 12px">Redes oficiales</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="https://facebook.com" target="_blank" rel="noopener">Facebook</a>
        <a class="btn" href="https://wa.me" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </section>

    <details class="card" id="pay" style="margin-top:12px">
      <summary>ðŸ’³ Medios de Pagos + Planes Premium â€“ DejandoHuella Trader</summary>
      <div class="pay-grid" style="margin-top:10px">
        <div class="pay-card">
          <h4>Banco Pichincha</h4>
          <img src="img/qr_pichincha.png" alt="QR Banco Pichincha" style="border-radius:10px;border:1px solid var(--line);max-width:320px;background:#081018"
               onerror="this.src='img/qr_arb1.png'">
          <div class="note">Cuenta/CCI verificada â€” solicita el detalle exacto antes de enviar.</div>
        </div>
        <div class="pay-card">
          <h4>Cripto</h4>
          <img src="img/qr_bep20.png" alt="QR BEP20" style="border-radius:10px;border:1px solid var(--line);max-width:320px;background:#081018">
          <div class="note">Red BEP20 / ERC20 segÃºn disponibilidad.</div>
        </div>
      </div>
    </details>

    <footer class="muted" style="text-align:center;margin:24px 0 10px">Â© 2025 DejandoHuella Trader</footer>
  </div>

  <!-- PGP Modal -->
  <div id="pgpModal" class="modal" aria-hidden="true">
    <div class="modal__card">
      <div class="modal__hdr">
        <strong>PGP pÃºblico â€” verifica la huella</strong>
        <div>
          <button id="btnCopyPGP" class="chip">Copiar</button>
          <button id="btnClosePGP" class="chip chip--bad">Cerrar</button>
        </div>
      </div>
      <textarea id="pgpText" class="txtarea" readonly>-----BEGIN PGP PUBLIC KEY BLOCK-----
mQENBGZmZkABCADaQ2C2F3X3b6T3Px8gQ0jWkQ3WZB4nVnYk6m1y7zW0h6o
... Coloca aquÃ­ tu llave PGP completa ...
=ABCD
-----END PGP PUBLIC KEY BLOCK-----</textarea>
      <div class="note">Si el fingerprint no coincide, no confÃ­es.</div>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);

    const btnRefresh   = $('#btnRefresh');
    const btnAuto      = $('#btnAuto');
    const btnCloseBar  = $('#btnCloseBar');
    const shot         = $('#shot');
    const lastUpdate   = $('#lastUpdate');

    const f_symbol = $('#f_symbol');
    const f_side   = $('#f_side');
    const f_price  = $('#f_price');
    const f_lot    = $('#f_lot');
    const f_sl     = $('#f_sl');
    const f_tp     = $('#f_tp');
    const f_time   = $('#f_time');
    const tblBody  = document.querySelector('#tblHistory tbody');

    const pgpModal   = $('#pgpModal');
    const btnPGP     = $('#btnPGP');
    const btnClosePGP= $('#btnClosePGP');
    const btnCopyPGP = $('#btnCopyPGP');
    const pgpText    = $('#pgpText');

    let autoTimer = null;

    function setUpdated(){
      if(lastUpdate) lastUpdate.textContent = 'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleString();
    }

    function bust(url){ return url + (url.includes('?')?'&':'?') + 'v=' + Date.now(); }

    async function fetchJSON(url){
      try{
        const r = await fetch(bust(url), {cache:'no-store'});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    async function fetchText(url){
      try{
        const r = await fetch(bust(url), {cache:'no-store'});
        if(!r.ok) return null;
        return await r.text();
      }catch(e){ return null; }
    }

    function renderHistory(trades){
      if(!Array.isArray(trades) || trades.length===0){
        tblBody.innerHTML = '<tr><td colspan="7" class="muted">Sin operaciones aÃºnâ€¦</td></tr>';
        return;
      }
      const rows = trades.slice(0,5).map(t => {
        const side = t.side||t.lado||'';
        const niceSide = /buy/i.test(side)? '<span class="ok">BUY</span>' :
                         /sell/i.test(side)? '<span style="color:#ff9aa7">SELL</span>' : side;
        const par  = t.symbol || t.par || '';
        const lot  = (t.lot ?? t.lote ?? '').toString();
        const sl   = t.sl ?? '';
        const tp   = t.tp ?? '';
        const pr   = t.price ?? t.precio ?? '';
        const tm   = t.ts  ?? t.hora   ?? '';
        return `<tr>
          <td>${tm}</td><td>${par}</td><td>${niceSide}</td><td>${pr}</td>
          <td>${lot}</td><td>${sl}</td><td>${tp}</td>
        </tr>`;
      }).join('');
      tblBody.innerHTML = rows;
    }

    function renderLive(last){
      if(!last) return;
      f_symbol.textContent = last.symbol ?? 'â€”';
      f_side.textContent   = last.side   ?? 'â€”';
      f_price.textContent  = last.price  ?? 'â€”';
      f_lot.textContent    = last.lot    ?? 'â€”';
      f_sl.textContent     = last.sl     ?? 'â€”';
      f_tp.textContent     = last.tp     ?? 'â€”';
      f_time.textContent   = last.ts     ?? 'â€”';
    }

    async function refreshAll(){
      // last.json
      const last = await fetchJSON('live/last.json');
      if(last) renderLive(last);
      // trades.json (array) o trades.jsonl (lÃ­nea por lÃ­nea)
      let trades = await fetchJSON('live/trades.json');
      if(!trades){
        const txt = await fetchText('live/trades.jsonl');
        if(txt){ trades = txt.trim().split('\\n').map(l=>{try{return JSON.parse(l)}catch(_){return null}}).filter(Boolean); }
      }
      renderHistory(trades || []);
      // shot
      if(shot){ shot.src = bust('live/shots/latest.jpg'); }
      setUpdated();
    }

    function setAuto(on){
      if(on){
        btnAuto.classList.add('chip--ok');
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(refreshAll, 5000);
      }else{
        btnAuto.classList.remove('chip--ok');
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = null;
      }
    }

    btnRefresh?.addEventListener('click', refreshAll);
    btnAuto?.addEventListener('click', ()=> setAuto(!autoTimer));
    btnCloseBar?.addEventListener('click', ()=>{
      const bar = document.querySelector('.topbar');
      if(bar) bar.style.display='none';
    });

    // PGP modal
    btnPGP?.addEventListener('click', ()=> { pgpModal.style.display='grid'; pgpModal.ariaHidden='false'; });
    btnClosePGP?.addEventListener('click', ()=> { pgpModal.style.display='none'; pgpModal.ariaHidden='true'; });
    pgpModal?.addEventListener('click', e=>{ if(e.target===pgpModal){ pgpModal.style.display='none'; pgpModal.ariaHidden='true'; }});
    btnCopyPGP?.addEventListener('click', ()=>{
      pgpText.select();
      try{ document.execCommand('copy'); btnCopyPGP.textContent='Â¡Copiado!'; setTimeout(()=>btnCopyPGP.textContent='Copiar',1200); }
      catch(_){}
    });

    // Initial
    refreshAll();
  })();
  </script>
</body>
</html>
