<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DejandoHuella Trader</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">

  <!-- PANEL DE ALERTA -->
  <div id="site-alert" class="alert">
    <span>Mensaje de alerta importante</span>
    <button data-alert-close>&times;</button>
  </div>

  <!-- DETALLES DE CONTACTO -->
  <section id="contacto">
    <details>
      <summary id="btn-info" aria-expanded="false">Solicitar información</summary>
      <div id="panel-info">
        <pre>
======= BEGIN PGP PUBLIC KEY BLOCK =======
-----END PGP PUBLIC KEY BLOCK-----
        </pre>
      </div>
    </details>
  </section>

  <!-- TRANSPARENCIA DE SEÑALES -->
  <div class="card">
    <h2>Transparencia de señales</h2>
    <p>✅ <b>BTCUSD BUY (BREAK_L2)</b><br>
    L1..L4 • EMA50/200 • ADX/+DI/−DI • RSI • ATR • Zona</p>
  </div>

  <!-- HISTORIAL Y EN VIVO -->
  <div class="card">
    <table id="hist-table">
      <thead>
        <tr>
          <th>Fecha/Hora</th><th>Símbolo</th><th>Side</th><th>Precio</th><th>Lotes</th><th>SL</th><th>TP</th>
        </tr>
      </thead>
      <tbody id="hist-body"></tbody>
    </table>
    <p id="hist-empty" style="display:none;">No hay operaciones recientes.</p>

    <div id="live-panel">
      <p>
        Símbolo: <span id="lv-symbol">—</span> | 
        Side: <span id="lv-side">—</span> | 
        Precio: <span id="lv-price">—</span> | 
        Lotes: <span id="lv-lots">—</span> | 
        SL/TP: <span id="lv-sltp">— / —</span> | 
        Hora: <span id="lv-ts">—</span>
      </p>
      <img id="lv-shot" src="live/shots/latest.jpg" alt="Captura en vivo" loading="lazy">
      <div id="status-pill"><span id="dot"></span> <span id="status-text">Desconectado</span></div>
    </div>
  </div>

  <!-- QR dinámicos -->
  <div class="qr-container">
    <div class="qrbox" data-key="btc" id="qr-btc"></div>
    <div class="qrbox" data-key="trc20" id="qr-trc20"></div>
    <div class="qrbox" data-key="bep20" id="qr-bep20"></div>
    <div class="qrbox" data-key="erc20" id="qr-erc20"></div>
    <div class="qrbox" data-key="arb1" id="qr-arb1"></div>
  </div>

  <!-- FOOTER -->
  <footer class="card" style="margin-top:16px">
    <p>
      Clearnet: <a href="./">Abrir sitio</a> |
      .onion: <code>xsfd6o4hs4lffweef6jnfkfvyhmnldi5ng7zjccev2kouh5grsvvh4yd.onion</code>
    </p>
    <p>Contacto: <a href="mailto:dejandohuella_pool@proton.me">dejandohuella_pool@proton.me</a></p>
  </footer>

  <p style="color:#94a3b8"><small>Última actualización: <span id="lu"></span></small></p>
  <small style="color:#94a3b8">© 2025 DejandoHuella Trader</small>

</div>

<!-- LIBRERÍA QR -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-2Y8A1aR8fWm9rTqvQXoQd7CjD2LdWw6Qy3r1r0q8oC0l1v2m2o2d6q9hX2u3XoCIiXv2iVwV4J7v3gQn1G8z0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(function(){
  // ===== UTILIDADES =====
  const $ = (id) => document.getElementById(id);
  const root = document.documentElement;
  const LIVE_ROOT = (window.DH_ROOT || 'live');
  const liveEls = {sym:$('lv-symbol'), side:$('lv-side'), price:$('lv-price'), lots:$('lv-lots'), sltp:$('lv-sltp'), ts:$('lv-ts'), img:$('lv-shot')};
  const status = { pill:$('status-pill'), dot:$('dot'), text:$('status-text') };
  let lastUpdate = 0;

  function setStatus(ok){
    const now = Date.now();
    if(ok){ lastUpdate = now; status.dot.style.background = '#16a34a'; status.text.textContent = 'En vivo'; }
    else{
      const age = now - lastUpdate;
      if(age > 10000){ status.dot.style.background = '#f87171'; status.textContent = 'Desconectado'; }
      else{ status.dot.style.background = '#f59e0b'; status.textContent = 'Reintentando…'; }
    }
  }

  function badgeHTML(text){
    const s=(text||'').toUpperCase();
    let color='#9aa6bd';
    if(s.includes('BUY'))  color='#16a34a';
    if(s.includes('SELL')) color='#dc2626';
    return `<span class="badge" style="background:${color}22;color:${color}">${s||'—'}</span>`;
  }

  function nice(n,dp){ if(n===undefined||n===null||n==='')return '—'; const x=Number(n); if(Number.isNaN(x))return '—'; return dp===undefined?x.toString():x.toFixed(dp); }
  function localTs(ts){ if(!ts)return '—'; const t=ts.replace(/\./g,'-').replace(' ','T'); const d=new Date(t); return Number.isNaN(+d)?ts:d.toLocaleString(); }

  function toast(text){
    const msg=document.createElement('div'); msg.textContent=text;
    Object.assign(msg.style,{position:'fixed',bottom:'20px',right:'20px',background:'#22c55e',color:'#06250f',padding:'8px 12px',borderRadius:'8px',boxShadow:'0 2px 8px rgba(0,0,0,.4)',zIndex:'9999'});
    document.body.appendChild(msg); setTimeout(()=>msg.remove(),1500);
  }

  window.copyTxt = function(id){
    const el=$(id); if(!el) return;
    const txt=el.textContent.trim();
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(txt).then(()=>{toast('✔ Copiado'); if(navigator.vibrate) navigator.vibrate(15);});
    }else{
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
      ta.select(); try{document.execCommand('copy');toast('✔ Copiado'); if(navigator.vibrate) navigator.vibrate(15);}catch(_){}
      ta.remove();
    }
  };

  // ===== QR dinámicos =====
  const ADDR={btc:'bc1qu6c2036ehv2rssqv32mzv5z9tf92px6q8wp0f4',trc20:'TCoqxfkqA4MAmTbqtWnCzwBzQToecwSiHd',bep20:'0xa721CD06Fce89aAD41e7f8eC6604653712B7c22F',arb1:'0xa721CD06Fce89aAD41e7f8eC6604653712B7c22F',erc20:'0xa721CD06Fce89aAD41e7f8eC6604653712B7c22F'};
  function ensureQR(boxId,text,key){
    const box=$(boxId);
    if(!box || box.dataset.done) return;
    if(window.QRCode){ new QRCode(box,{text, width:180, height:180, correctLevel:QRCode.CorrectLevel.M}); }
    else{ const img=document.createElement('img'); img.alt='QR '+(key||''); img.loading='lazy'; img.decoding='async'; img.src='img/qr_'+key+'.png'; box.appendChild(img); }
    box.dataset.done='1';
  }
  document.querySelectorAll('.qrbox').forEach(d=>{
    d.addEventListener('toggle', ()=>{ if(!d.open) return; const key=d.dataset.key; const target='qr-'+key; if(key && ADDR[key]) ensureQR(target,ADDR[key],key); });
  });

  // ===== FETCH POLLING HISTORIAL Y EN VIVO =====
  async function updateLast(){
    try{
      const last = await window.DH_FETCH_JSON('/last.json');
      liveEls.sym.textContent = last.symbol || '—';
      liveEls.side.innerHTML  = badgeHTML(last.side);
      liveEls.price.textContent = nice(last.price);
      liveEls.lots.textContent  = nice(last.lot ?? last.lots, 2);
      liveEls.sltp.textContent  = `${nice(last.sl)} / ${nice(last.tp)}`;
      liveEls.ts.textContent    = localTs(last.ts);
      liveEls.img.src = `${LIVE_ROOT}/shots/latest.jpg?ts=${Date.now()}`;
      setStatus(true);
    }catch(_){ setStatus(false); }
  }

  async function updateHist(){
    const tbl=$('hist-table'), body=$('hist-body'), empty=$('hist-empty');
    try{
      const txt = await window.DH_FETCH_JSONL('/trades.jsonl');
      const last10 = txt.slice(-10).reverse();
      if(!last10.length){ tbl.style.display='none'; empty.style.display='block'; return; }
      empty.style.display='none'; tbl.style.display='table';
      body.innerHTML = last10.map(r=>`
        <tr>
          <td>${ localTs(r.ts) }</td>
          <td>${ r.symbol||'—' }</td>
          <td>${ badgeHTML(r.side) }</td>
          <td style="text-align:right">${ nice(r.price) }</td>
          <td style="text-align:right">${ nice(r.lot ?? r.lots, 2) }</td>
          <td style="text-align:right">${ nice(r.sl) }</td>
          <td style="text-align:right">${ nice(r.tp) }</td>
        </tr>`).join('');
      setStatus(true);
    }catch(_){ setStatus(false); }
  }

  updateLast(); updateHist();
  setInterval(updateLast, 5000);
  setInterval(updateHist, 7000);

  // ===== FECHA ISO =====
  $('lu').textContent = new Date().toISOString().slice(0,10);

})();
</script>

</body>
</html>
